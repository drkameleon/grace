<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="lib/bulma/bulma.min.css">
        <script src="https://unpkg.com/lucide@latest"></script>
        <style type="text/css" media="screen">
            * {
                user-select: none;
                -webkit-user-select: none;
            }
            #editor { 
                position: absolute;
                top: 0;
                right: 0;
                bottom: 40px;
                left: 0;
                user-select: text;
                -webkit-user-select: text;
            }
            #statusbar {
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 40px;
                background-color: #f5f5f5;
                border-top: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: stretch;
            }
            .select, .position-info {
                font-size: 0.875rem;
            }
            .position-info {
                color: #666;
                display: flex;
                align-items: center;
            }
            .settings-button {
                display: flex;
                align-items: center;
                padding: 0 8px 0 4px;
                margin-right: 15px;
                border-right: 1px solid #ddd;
                height: 100%;
            }
            .settings-button:hover {
                background-color: rgba(0,0,0,0.05);
            }
            .settings-button svg {
                width: 16px;
                height: 16px;
                color: #666;
            }
            .controls {
                display: flex;
                height: 100%;
            }
            .select-wrapper {
                position: relative;
                height: 100%;
                border-left: 1px solid #ddd;
                display: flex;
                align-items: center;
                padding: 0 15px;
            }
            .select-wrapper::after {
                content: "";
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 0;
                height: 0;
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-top: 4px solid #666;
                pointer-events: none;
            }
            .select-wrapper select {
                border: none;
                background: none;
                padding-right: 1.5em;
                cursor: pointer;
                font-size: 0.875rem;
                color: #666;
                -webkit-appearance: none;
                appearance: none;
            }
            .select-wrapper select:focus {
                outline: none;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.4);
            }
            .modal-content {
                background-color: #fff;
                margin: 15% auto;
                width: 400px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            .modal-header {
                padding: 15px 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .modal-title {
                margin: 0;
                font-size: 1.1em;
                font-weight: 500;
                color: #333;
                flex-grow: 1;
            }
            .modal-close {
                display: flex;
                padding: 4px;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 15px;
            }
            .modal-close svg {
                width: 18px;
                height: 18px;
                color: #999;
            }
            .modal-close:hover {
                background-color: rgba(0,0,0,0.05);
            }
            .modal-close:hover svg {
                color: #666;
            }
            .modal-body {
                padding: 20px;
            }
            .setting-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            .setting-row:last-child {
                margin-bottom: 0;
            }
            .setting-row label {
                color: #666;
                font-size: 0.9em;
            }
            .setting-row select {
                width: 200px;
                padding: 6px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background-color: #fff;
                font-size: 0.9em;
                color: #333;
            }
            .setting-row select:focus {
                outline: none;
                border-color: #4a9eff;
            }
        </style>
    </head>
    <body>
        <div id="editor">function helloGrace() {
    var x = "This is a very silly example";
    console.log("but still works...");
    return x;
}</div>
        <div id="statusbar">
            <div class="position-info">
                <div class="settings-button" id="settingsButton">
                    <i data-lucide="settings"></i>
                </div>
                <span>Line: <span id="lineCounter">1</span>, Column: <span id="columnCounter">1</span></span>
            </div>
            <div class="controls">
                <div class="select-wrapper">
                    <select id="indentSizeSelect">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="4" selected>4</option>
                        <option value="8">8</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="indentTypeSelect">
                        <option value="spaces" selected>Spaces</option>
                        <option value="tabs">Tabs</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="syntaxSelect">
                        <option value="javascript" selected>JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Editor Settings
                    <div class="modal-close">
                        <i data-lucide="x"></i>
                    </div>
                </h3>
                </div>
                <div class="modal-body">
                    <div class="setting-row">
                        <label>Font Family</label>
                        <select id="fontSelect"></select>
                    </div>
                    <div class="setting-row">
                        <label>Theme</label>
                        <select id="themeSelect">
                            <option value="ambiance">Ambiance</option>
                            <option value="chaos">Chaos</option>
                            <option value="chrome">Chrome</option>
                            <option value="clouds_midnight">Clouds Midnight</option>
                            <option value="clouds">Clouds</option>
                            <option value="cobalt">Cobalt</option>
                            <option value="crimson_editor">Crimson Editor</option>
                            <option value="dawn">Dawn</option>
                            <option value="dracula">Dracula</option>
                            <option value="dreamweaver">Dreamweaver</option>
                            <option value="eclipse">Eclipse</option>
                            <option value="github_dark">GitHub Dark</option>
                            <option value="github">GitHub Light</option>
                            <option value="gruvbox">Gruvbox</option>
                            <option value="idle_fingers">Idle Fingers</option>
                            <option value="iplastic">IPlastic</option>
                            <option value="monokai" selected>Monokai</option>
                            <option value="nord_dark">Nord Dark</option>
                            <option value="one_dark">One Dark</option>
                            <option value="solarized_dark">Solarized Dark</option>
                            <option value="solarized_light">Solarized Light</option>
                            <option value="terminal">Terminal</option>
                            <option value="textmate">TextMate</option>
                            <option value="tomorrow_night">Tomorrow Night</option>
                            <option value="tomorrow">Tomorrow</option>
                            <option value="twilight">Twilight</option>
                            <option value="xcode">Xcode</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <script src="lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
        <script>
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/javascript");
            
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Update line/column counter
            editor.selection.on('changeCursor', function() {
                var pos = editor.getCursorPosition();
                document.getElementById('lineCounter').textContent = pos.row + 1;
                document.getElementById('columnCounter').textContent = pos.column + 1;
            });

            // Handle settings modal
            const modal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsButton');
            const closeBtn = document.querySelector('.modal-close');

            settingsBtn.onclick = function(e) {
                modal.style.display = "block";
                e.stopPropagation();
            }

            closeBtn.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // Handle theme changes
            document.getElementById('themeSelect').addEventListener('change', function(e) {
                editor.setTheme("ace/theme/" + e.target.value);
            });

            // Initialize available fonts
            async function populateMonospaceFonts() {
                const fonts = await document.fonts.ready;
                const fontSelect = document.getElementById('fontSelect');
                
                const testString = 'ili1WM';
                const testSize = '72px';
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                function checkFontAvailable(font) {
                    const baseWidth = context.measureText(testString).width;
                    try {
                        context.font = `${testSize} ${font}, monospace`;
                        return context.measureText(testString).width !== baseWidth;
                    } catch (e) {
                        return false;
                    }
                }

                const availableFonts = [
                    'Consolas', 'Monaco', 'Menlo', 'Source Code Pro', 'Fira Code', 
                    'JetBrains Mono', 'Cascadia Code', 'IBM Plex Mono', 'Ubuntu Mono',
                    'Courier New', 'DejaVu Sans Mono', 'Liberation Mono', 'Roboto Mono',
                    'PT Mono', 'Inconsolata', 'Hack', 'Droid Sans Mono', 'Anonymous Pro'
                ].filter(checkFontAvailable);

                availableFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    fontSelect.appendChild(option);
                });
            }

            populateMonospaceFonts();

            // Handle font changes
            document.getElementById('fontSelect').addEventListener('change', function(e) {
                editor.container.style.fontFamily = e.target.value;
            });

            // Handle indentation changes
            document.getElementById('indentSizeSelect').addEventListener('change', function(e) {
                const newSize = parseInt(e.target.value);
                const oldSize = editor.session.getTabSize();
                editor.session.setTabSize(newSize);
                
                const lines = editor.session.doc.getAllLines();
                lines.forEach((line, i) => {
                    if (line.trim()) {
                        const indent = line.match(/^\s*/)[0];
                        const indentLevel = Math.floor(indent.length / oldSize);
                        const newIndent = ' '.repeat(indentLevel * newSize);
                        editor.session.doc.removeInLine(i, 0, indent.length);
                        editor.session.doc.insertInLine({row: i, column: 0}, newIndent);
                    }
                });
            });

            document.getElementById('indentTypeSelect').addEventListener('change', function(e) {
                const useTabs = e.target.value === 'tabs';
                editor.session.setUseSoftTabs(!useTabs);
                
                const size = editor.session.getTabSize();
                const lines = editor.session.doc.getAllLines();
                
                lines.forEach((line, i) => {
                    if (line.trim()) {
                        const indent = line.match(/^\s*/)[0];
                        const indentLevel = Math.floor(indent.length / size);
                        const newIndent = useTabs ? '\t'.repeat(indentLevel) : ' '.repeat(indentLevel * size);
                        
                        editor.session.doc.removeInLine(i, 0, indent.length);
                        editor.session.doc.insertInLine({row: i, column: 0}, newIndent);
                    }
                });
            });

            // Handle syntax changes
            document.getElementById('syntaxSelect').addEventListener('change', function(e) {
                editor.session.setMode("ace/mode/" + e.target.value);
            });

            document.getElementById('editor').style.display = 'block';
        </script>
    </body>
</html>