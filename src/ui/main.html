<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="lib/bulma/bulma.min.css">
        <script src="https://unpkg.com/lucide@latest"></script>
        <style type="text/css" media="screen">
            * {
                user-select: none;
                -webkit-user-select: none;
            }
            #editor { 
                position: absolute;
                top: 0;
                right: 0;
                bottom: 40px;
                left: 0;
                user-select: text;
                -webkit-user-select: text;
            }
            #statusbar {
                position: absolute;
                bottom: 0;
                width: 100%;
                height: 40px;
                background-color: #f5f5f5;
                border-top: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: stretch;
            }
            .select, .position-info {
                font-size: 0.875rem;
            }
            .position-info {
                color: #666;
                display: flex;
                align-items: center;
            }
            .settings-button {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                margin-right: 15px;
                border-right: 1px solid #ddd;
                height: 100%;
            }
            .settings-button:hover {
                background-color: rgba(0,0,0,0.05);
            }
            .settings-button svg {
                width: 16px;
                height: 16px;
                color: #666;
            }
            .controls {
                display: flex;
                height: 100%;
            }
            .select-wrapper {
                position: relative;
                height: 100%;
                border-left: 1px solid #ddd;
                display: flex;
                align-items: center;
                padding: 0 15px;
            }
            .select-wrapper::after {
                content: "";
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 0;
                height: 0;
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-top: 4px solid #666;
                pointer-events: none;
            }
            .select-wrapper select {
                border: none;
                background: none;
                padding-right: 1.5em;
                cursor: pointer;
                font-size: 0.875rem;
                color: #666;
                -webkit-appearance: none;
                appearance: none;
            }
            .select-wrapper select:focus {
                outline: none;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.4);
            }
            .modal {
                display: none;
            }
            .modal-card {
                width: 400px;
                margin: 0 auto;
                margin-top: 10%;
            }
            .font-size-control {
                display: flex;
                align-items: center;
                gap: 15px;
                width: 200px;
            }
            .font-size-control input[type="range"] {
                flex: 1;
                height: 6px;
                -webkit-appearance: none;
                background: #ddd;
                border-radius: 3px;
            }
            .font-size-control input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: #4a9eff;
                cursor: pointer;
                border: none;
            }
            .font-size-control input[type="range"]:focus {
                outline: none;
            }
            #fontSizeValue {
                font-size: 0.9em;
                color: #666;
                min-width: 45px;
            }
            .modal-card-body {
                padding: 20px;
            }
            .setting-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            .setting-row:last-child {
                margin-bottom: 0;
            }
            .setting-row label {
                color: #666;
                font-size: 0.9em;
            }
            .setting-row select {
                width: 200px;
                padding: 6px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background-color: #fff;
                font-size: 0.9em;
                color: #333;
            }
            .setting-row select:focus {
                outline: none;
                border-color: #4a9eff;
            }
            .font-size-control {
                display: flex;
                align-items: center;
                gap: 10px;
                width: 200px;
            }
            .font-size-control input[type="range"] {
                flex: 1;
            }
            #fontSizeValue {
                font-size: 0.9em;
                color: #666;
                min-width: 45px;
            }
        </style>
    </head>
    <body>
        <div id="editor">function helloGrace() {
    var x = "This is a very silly example";
    console.log("but still works...");
    return x;
}</div>
        <div id="statusbar">
            <div class="position-info">
                <div class="settings-button" id="settingsButton">
                    <i data-lucide="settings"></i>
                </div>
                <span>Line: <span id="lineCounter">1</span>, Column: <span id="columnCounter">1</span></span>
            </div>
            <div class="controls">
                <div class="select-wrapper">
                    <select id="indentSizeSelect">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="4" selected>4</option>
                        <option value="8">8</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="indentTypeSelect">
                        <option value="spaces" selected>Spaces</option>
                        <option value="tabs">Tabs</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="syntaxSelect">
                        <option value="javascript" selected>JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Settings</p>
                    <button class="delete" aria-label="close"></button>
                </header>
                <section class="modal-card-body">
                    <div class="setting-row">
                        <label>Font Family</label>
                        <select id="fontSelect"></select>
                    </div>
                    <div class="setting-row">
                        <label>Font Size</label>
                        <div class="font-size-control">
                            <input type="range" id="fontSizeRange" min="8" max="24" value="14" step="1">
                            <span id="fontSizeValue">14px</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label>Theme</label>
                        <select id="themeSelect">
                            <optgroup label="Dark Themes">
                                <option value="ambiance">Ambiance</option>
                                <option value="chaos">Chaos</option>
                                <option value="clouds_midnight">Clouds Midnight</option>
                                <option value="cobalt">Cobalt</option>
                                <option value="dracula">Dracula</option>
                                <option value="github_dark">GitHub Dark</option>
                                <option value="gruvbox">Gruvbox</option>
                                <option value="idle_fingers">Idle Fingers</option>
                                <option value="monokai" selected>Monokai</option>
                                <option value="nord_dark">Nord Dark</option>
                                <option value="one_dark">One Dark</option>
                                <option value="solarized_dark">Solarized Dark</option>
                                <option value="terminal">Terminal</option>
                                <option value="tomorrow_night">Tomorrow Night</option>
                                <option value="twilight">Twilight</option>
                            </optgroup>
                            <optgroup label="Light Themes">
                                <option value="chrome">Chrome</option>
                                <option value="clouds">Clouds</option>
                                <option value="crimson_editor">Crimson Editor</option>
                                <option value="dawn">Dawn</option>
                                <option value="dreamweaver">Dreamweaver</option>
                                <option value="eclipse">Eclipse</option>
                                <option value="github">GitHub Light</option>
                                <option value="iplastic">IPlastic</option>
                                <option value="solarized_light">Solarized Light</option>
                                <option value="textmate">TextMate</option>
                                <option value="tomorrow">Tomorrow</option>
                                <option value="xcode">Xcode</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <script src="lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
        <script>
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/javascript");
            
            // Set initial gutter width to settings button
            function updateSettingsButtonWidth() {
                const gutter = document.querySelector('.ace_gutter');
                if (gutter) {
                    const width = gutter.offsetWidth;
                    document.querySelector('.settings-button').style.width = width + 'px';
                }
            }
            
            // Update width when editor changes
            // Update gutter width whenever content changes
            editor.session.on('change', () => {
                setTimeout(updateSettingsButtonWidth, 0);
            });
            
            editor.session.on('changeScrollLeft', updateSettingsButtonWidth);
            editor.renderer.on('resize', updateSettingsButtonWidth);
            editor.session.on('changeScrollTop', updateSettingsButtonWidth);
            
            // Initial setup
            setTimeout(updateSettingsButtonWidth, 100);
            
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Update line/column counter
            editor.selection.on('changeCursor', function() {
                var pos = editor.getCursorPosition();
                document.getElementById('lineCounter').textContent = pos.row + 1;
                document.getElementById('columnCounter').textContent = pos.column + 1;
            });

            // Handle settings modal
            const modal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsButton');
            const closeBtn = document.querySelector('.modal-close');

            settingsBtn.onclick = function(e) {
                modal.style.display = "block";
                e.stopPropagation();
            }

            closeBtn.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // Handle theme changes
            document.getElementById('themeSelect').addEventListener('change', function(e) {
                editor.setTheme("ace/theme/" + e.target.value);
            });

            // Initialize available fonts
            async function populateMonospaceFonts() {
                const fonts = await document.fonts.ready;
                const fontSelect = document.getElementById('fontSelect');
                
                const testString = 'ili1WM';
                const testSize = '72px';
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                function checkFontAvailable(font) {
                    const baseWidth = context.measureText(testString).width;
                    try {
                        context.font = `${testSize} ${font}, monospace`;
                        return context.measureText(testString).width !== baseWidth;
                    } catch (e) {
                        return false;
                    }
                }

                const availableFonts = [
                    'Consolas', 'Monaco', 'Menlo', 'Source Code Pro', 'Fira Code', 
                    'JetBrains Mono', 'Cascadia Code', 'IBM Plex Mono', 'Ubuntu Mono',
                    'Courier New', 'DejaVu Sans Mono', 'Liberation Mono', 'Roboto Mono',
                    'PT Mono', 'Inconsolata', 'Hack', 'Droid Sans Mono', 'Anonymous Pro'
                ].filter(checkFontAvailable);

                availableFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    fontSelect.appendChild(option);
                });
            }

            populateMonospaceFonts();

            // Handle font changes
            document.getElementById('fontSelect').addEventListener('change', function(e) {
                editor.container.style.fontFamily = e.target.value;
            });

            // Handle font size changes
            const fontSizeRange = document.getElementById('fontSizeRange');
            const fontSizeValue = document.getElementById('fontSizeValue');
            
            fontSizeRange.addEventListener('input', function(e) {
                const size = e.target.value;
                fontSizeValue.textContent = size + 'px';
                editor.setFontSize(parseInt(size));
            });

            // Handle indentation changes
            document.getElementById('indentSizeSelect').addEventListener('change', function(e) {
                const newSize = parseInt(e.target.value);
                const oldSize = editor.session.getTabSize();
                editor.session.setTabSize(newSize);
                
                const lines = editor.session.doc.getAllLines();
                lines.forEach((line, i) => {
                    if (line.trim()) {
                        const indent = line.match(/^\s*/)[0];
                        const indentLevel = Math.floor(indent.length / oldSize);
                        const newIndent = ' '.repeat(indentLevel * newSize);
                        editor.session.doc.removeInLine(i, 0, indent.length);
                        editor.session.doc.insertInLine({row: i, column: 0}, newIndent);
                    }
                });
            });

            document.getElementById('indentTypeSelect').addEventListener('change', function(e) {
                const useTabs = e.target.value === 'tabs';
                editor.session.setUseSoftTabs(!useTabs);
                
                const size = editor.session.getTabSize();
                const lines = editor.session.doc.getAllLines();
                
                lines.forEach((line, i) => {
                    if (line.trim()) {
                        const indent = line.match(/^\s*/)[0];
                        const indentLevel = Math.floor(indent.length / size);
                        const newIndent = useTabs ? '\t'.repeat(indentLevel) : ' '.repeat(indentLevel * size);
                        
                        editor.session.doc.removeInLine(i, 0, indent.length);
                        editor.session.doc.insertInLine({row: i, column: 0}, newIndent);
                    }
                });
            });

            // Handle syntax changes
            document.getElementById('syntaxSelect').addEventListener('change', function(e) {
                editor.session.setMode("ace/mode/" + e.target.value);
            });

            document.getElementById('editor').style.display = 'block';
        </script>
    </body>
</html>