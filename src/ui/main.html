<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css" media="print" onload="this.media='all'">
    <style>
        /* Variables */
        :root {
            --modal-bg: #fff;
            --modal-border: #eee;
            --text-color: #666;
            --hover-bg: rgba(0,0,0,0.05);
            --modal-overlay: rgba(0, 0, 0, 0.2);
            --statusbar-bg: #f5f5f5;
            --statusbar-border: #ddd;
            --statusbar-divider: #ddd;
            --spinner-track: #f3f3f3;
            --spinner-active: #41B883;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --modal-bg: #2c2c2c;
                --modal-border: #444;
                --text-color: #ccc;
                --hover-bg: rgba(255,255,255,0.05);
                --modal-overlay: rgba(0, 0, 0, 0.4);
                --statusbar-bg: #1c1c1c;
                --statusbar-border: #333;
                --statusbar-divider: #333;
                --modal-header-text: #fff;
                --input-bg: #3a3a3a;
                --input-text: #fff;
                --label-text: #bbb;
                --checkbox-text: #ddd;
                --slider-text: #ddd;
                --spinner-track: #2C2C2C;
                --spinner-active: #41B883;
            }
        }

        /* Base */
        * { user-select: none; -webkit-user-select: none; overscroll-behavior: none;}

        /* Editor */
        #editor { 
            position: absolute;
            top: 0;
            right: 0;
            bottom: 40px;
            left: 0;
            user-select: text;
            -webkit-user-select: text;
        }

        /* Status Bar */
        #statusbar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40px;
            background-color: var(--statusbar-bg);
            border-top: 1px solid var(--statusbar-border);
            display: flex;
            justify-content: space-between;
            align-items: stretch;
        }

        .select, .position-info { 
            font-size: 0.875rem; 
        }

        .position-info {
            color: var(--text-color);
            display: flex;
            align-items: center;
        }

        .position-info span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: inline-block;
        }

        .settings-button {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            border-right: 1px solid var(--statusbar-divider);
            height: 100%;
            transition: width 0.2s;
            cursor: pointer;
        }

        .settings-button:hover { 
            background-color: var(--hover-bg); 
        }

        .settings-button svg {
            width: 16px;
            height: 16px;
            color: var(--text-color);
        }

        .controls {
            display: flex;
            height: 100%;
        }

        .select-wrapper {
            position: relative;
            height: 100%;
            border-left: 1px solid var(--statusbar-divider);
            display: flex;
            align-items: center;
            padding: 0 15px;
        }

        .select-wrapper::after {
            content: "";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-color);
            pointer-events: none;
        }

        .select-wrapper select {
            border: none;
            background: none;
            padding-right: 1.5em;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-color);
            -webkit-appearance: none;
            appearance: none;
        }

        .select-wrapper select:focus {
            outline: none;
        }

        /* Modal */
        .modal-background {
            background-color: var(--modal-overlay) !important;
        }

        .modal-card {
            width: 400px;
            margin: 0 auto;
            margin-top: 10px !important;
        }

        .modal-card-head {
            padding: 10px 15px;
            background: var(--modal-bg);
        }

        .modal-card-title {
            font-size: 1rem;
            color: var(--modal-header-text);
        }

        .modal-card-body {
            padding: 20px 25px;
            background: var(--modal-bg);
        }

        .modal-card-foot {
            padding: 10px 15px;
            justify-content: flex-end;
            background: var(--modal-bg);
            border-top: 1px solid var(--modal-border);
        }

        .modal-card-foot .button {
            background: transparent;
            border: none;
            color: var(--text-color);
            height: 2em;
            padding: 0 1em;
        }

        .modal-card-foot .button:hover {
            background: var(--hover-bg);
        }

        /* Settings Form */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-row label {
            color: var(--label-text);
            font-size: 0.9em;
        }

        .setting-row select {
            width: 200px;
            padding: 6px 12px;
            border: 1px solid var(--statusbar-divider);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--input-text);
            font-size: 0.9em;
            appearance: none;
        }

        .setting-row select:hover {
            border-color: #4a9eff;
        }

        .setting-row select:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 1px #4a9eff;
        }

        /* Remove gradient from select in WebKit */
        .setting-row select {
            background-image: none;
        }

        /* Custom dropdown arrow */
        .setting-row {
            position: relative;
        }

        .setting-row:has(select)::after {
            content: "";
            position: absolute;
            right: 12px;
            top: 50%;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--text-color);
            pointer-events: none;
        }

        /* Font Size Control */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 200px;
            justify-content: space-between;
        }

        /* Slider styling */
        .font-size-control input[type="range"] {
            -webkit-appearance: none;
            background: var(--input-bg);
            border: 1px solid var(--statusbar-divider);
            border-radius: 4px;
            height: 8px;
            width: 140px; /* Adjust width to match dropdowns */
        }

        .font-size-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 4px;
            background: #4a9eff;
            cursor: pointer;
            border: none;
        }

        .font-size-control input[type="range"]:focus {
            border-color: #4a9eff;
            box-shadow: 0 0 0 1px #4a9eff;
        }

        .font-size-control span {
            color: var(--slider-text);
            min-width: 40px; /* Ensure consistent width */
            text-align: right;
        }

        /* Word Wrap Toggle */
        .word-wrap-toggle {
            display: flex;
            align-items: center;
        }

        .word-wrap-toggle input[type="checkbox"] {
            margin-right: 8px;
        }

        .word-wrap-toggle span {
            color: var(--checkbox-text);
        }

        /* Checkbox styling */
        .word-wrap-toggle input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid var(--statusbar-divider);
            border-radius: 4px;
            background: var(--input-bg);
            cursor: pointer;
            position: relative;
            margin-right: 8px;
        }

        .word-wrap-toggle input[type="checkbox"]:checked {
            background: #4a9eff;
            border-color: #4a9eff;
        }

        .word-wrap-toggle input[type="checkbox"]:checked::after {
            content: "";
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--modal-bg);
            z-index: 9999;
            transition: background-color 0.3s ease;
            }

            .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--spinner-track);
            border-top: 5px solid var(--spinner-active);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            }

            .loading-text {
            margin-top: 20px;
            color: var(--text-color);
            font-size: 16px;
            transition: color 0.3s ease;
            }

            /* Dark mode overrides for Bulma */
            @media (prefers-color-scheme: dark) {
            .hero.is-fullheight {
                background-color: var(--modal-bg);
            }
            
            .hero-body {
                background-color: var(--modal-bg);
            }
            }

            @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
            }

            .fade-out {
            animation: fadeOut 0.5s ease-in-out forwards;
            }

            @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
            }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-container">
        <div class="hero is-fullheight">
          <div class="hero-body">
            <div class="container has-text-centered">
              <div class="spinner"></div>
              <div class="loading-text">Loading...</div>
            </div>
          </div>
        </div>
      </div>
    <div id="app">
        <div id="editor">function helloGrace() {<br>
    console.log("Hello, Grace!");<br>
    return "Hello!";<br>
}</div>
        <div id="statusbar">
            <div class="position-info">
                <div class="settings-button" @click="openSettingsModal">
                    <i data-lucide="settings"></i>
                </div>
                <span>Line: {{ cursor.row }}, Column: {{ cursor.column }}</span>
            </div>
            <div class="controls">
                <div class="select-wrapper">
                    <select v-model="indentSize">
                        <option v-for="size in [1,2,4,8]" :value="size">{{ size }}</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select v-model="indentType">
                        <option value="spaces">Spaces</option>
                        <option value="tabs">Tabs</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select v-model="syntax">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                    </select>
                </div>
            </div>
        </div>
     
        <div class="modal" :class="{'is-active': isSettingsModalOpen}">
            <div class="modal-background" @click="closeSettingsModal"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Settings</p>
                    <button class="delete is-small" @click="closeSettingsModal"></button>
                </header>
                <section class="modal-card-body">
                    <div class="setting-row">
                        <label>Font Family</label>
                        <select v-model="selectedFont">
                            <option v-for="font in availableFonts" :value="font">{{ font }}</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>Font Size</label>
                        <div class="font-size-control">
                            <input type="range" v-model="fontSize" min="8" max="24" step="1">
                            <span>{{ fontSize }}px</span>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label>Theme</label>
                        <select v-model="theme">
                            <optgroup label="Dark Themes">
                                <option v-for="theme in darkThemes" :value="theme.value">
                                    {{ theme.label }}
                                </option>
                            </optgroup>
                            <optgroup label="Light Themes">
                                <option v-for="theme in lightThemes" :value="theme.value">
                                    {{ theme.label }}
                                </option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>Word Wrap</label>
                        <div class="word-wrap-toggle">
                            <input type="checkbox" v-model="wordWrap">
                            <span>Enable word wrapping</span>
                        </div>
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-small" @click="restoreDefaults">
                        <i data-lucide="rotate-ccw" class="icon is-small mr-1"></i>
                        Restore Defaults
                    </button>
                </footer>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.24.1/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.add('fade-out');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }

        const { createApp, onMounted, ref, watch } = Vue;

        createApp({
            setup() {
                const editor = ref(null);
                const cursor = ref({ row: 1, column: 1 });
                const isSettingsModalOpen = ref(false);
                const syntax = ref('javascript');
                const theme = ref('monokai');
                const indentSize = ref(4);
                const indentType = ref('spaces');
                const fontSize = ref(14);
                const selectedFont = ref('Monaco');
                const availableFonts = ref([]);
                const wordWrap = ref(false);

                const defaultSettings = {
                    theme: 'monokai',
                    fontSize: 14,
                    selectedFont: 'Monaco',
                    wordWrap: false
                };

                const darkThemes = [
                    { value: 'ambiance', label: 'Ambiance' },
                    { value: 'chaos', label: 'Chaos' },
                    { value: 'cloud_editor_dark', label: 'Cloud Editor (Dark)' },
                    { value: 'cloud9_night', label: 'Cloud9 (Night)' },
                    { value: 'cloud9_night_low_color', label: 'Cloud9 (Night / Low Color)' },
                    { value: 'clouds_midnight', label: 'Clouds (Midnight)' },
                    { value: 'cobalt', label: 'Cobalt' },
                    { value: 'dracula', label: 'Dracula' },
                    { value: 'github_dark', label: 'GitHub (Dark)' },
                    { value: 'gob', label: 'Gob' },
                    { value: 'gruvbox_dark_hard', label: 'Gruvbox (Dark Hard)' },
                    { value: 'idle_fingers', label: 'Idle Fingers' },
                    { value: 'merbivore', label: 'Merbivore' },
                    { value: 'merbivore_soft', label: 'Merbivore (Soft)' },
                    { value: 'mono_industrial', label: 'Mono Industrial' },
                    { value: 'monokai', label: 'Monokai' },
                    { value: 'nord_dark', label: 'Nord Dark' },
                    { value: 'one_dark', label: 'One Dark' },
                    { value: 'pastel_on_dark', label: 'Pastel on Dark' },
                    { value: 'solarized_dark', label: 'Solarized (Dark)' },
                    { value: 'terminal', label: 'Terminal' },
                    { value: 'tomorrow_night', label: 'Tomorrow Night' },
                    { value: 'tomorrow_night_blue', label: 'Tomorrow Night (Blue)' },
                    { value: 'tomorrow_night_bright', label: 'Tomorrow Night (Bright)' },
                    { value: 'tomorrow_night_eighties', label: 'Tomorrow Night (Eighties)' },
                    { value: 'twilight', label: 'Twilight' },
                    { value: 'vibrant_ink', label: 'Vibrant Ink' }
                ];

                const lightThemes = [
                    { value: 'chrome', label: 'Chrome' },
                    { value: 'cloud_editor', label: 'Cloud Editor' },
                    { value: 'cloud9_day', label: 'Cloud9 (Day)' },
                    { value: 'clouds', label: 'Clouds' },
                    { value: 'crimson_editor', label: 'Crimson Editor' },
                    { value: 'dawn', label: 'Dawn' },
                    { value: 'dreamweaver', label: 'Dreamweaver' },
                    { value: 'eclipse', label: 'Eclipse' },
                    { value: 'github', label: 'GitHub' },
                    { value: 'github_light_default', label: 'GitHub (Light Default)' },
                    { value: 'gruvbox_light_hard', label: 'Gruvbox (Light Hard)' },
                    { value: 'iplastic', label: 'IPlastic' },
                    { value: 'katzenmilch', label: 'Katzenmilch' },
                    { value: 'kr_theme', label: 'KR Theme' },
                    { value: 'kuroir', label: 'Kuroir' },
                    { value: 'solarized_light', label: 'Solarized (Light)' },
                    { value: 'sqlserver', label: 'SQL Server' },
                    { value: 'textmate', label: 'TextMate' },
                    { value: 'tomorrow', label: 'Tomorrow' },
                    { value: 'xcode', label: 'Xcode' }
                ];

                async function detectMonospaceFonts() {
                    // Only the fonts from your Font Book listing
                    const allFonts = [
                        'Andale Mono', 'Courier New', 'Inconsolata', 'Menlo', 'Monaco', 
                        'Osaka Mono', 'PT Mono', 'SF Mono', 'Spot Mono', 'Lantinghei',
                        'PCMyongjo', 'DejaVu Sans Mono', 'Liberation Mono', 'Lucida Console',
                        'Fira Code', 'JetBrains Mono', 'Source Code Pro', 'Ubuntu Mono',
                        'Consolas', 'Roboto Mono', 'IBM Plex Mono', 'Anonymous Pro'
                    ];
                    
                    const fonts = await Promise.all(
                        allFonts.map(async font => {
                            try {
                                const fontFace = new FontFace(font, `local("${font}")`);
                                await fontFace.load();
                                return font;
                            } catch {
                                return null;
                            }
                        })
                    );
                    
                    return fonts.filter(font => font !== null);
                }

                function updateSettingsButtonWidth() {
                    const gutter = document.querySelector('.ace_gutter');
                    if (gutter) {
                        document.querySelector('.settings-button').style.width = gutter.offsetWidth + 'px';
                    }
                }

                function openSettingsModal() {
                    isSettingsModalOpen.value = true;
                }

                function closeSettingsModal() {
                    isSettingsModalOpen.value = false;
                }

                function restoreDefaults() {
                    theme.value = defaultSettings.theme;
                    fontSize.value = defaultSettings.fontSize;
                    selectedFont.value = defaultSettings.selectedFont;
                    wordWrap.value = defaultSettings.wordWrap;
                }

                function reformatIndentation(editor, size, type) {
                    const session = editor.session;
                    const lines = session.doc.getAllLines();
                    const useSpaces = type === 'spaces';
                    
                    // Store cursor position
                    const cursorPosition = editor.getCursorPosition();
                    
                    lines.forEach((line, index) => {
                        // Count leading whitespace
                        const match = line.match(/^\s*/);
                        if (match) {
                            const indentLevel = match[0].length / session.getTabSize();
                            const newIndent = useSpaces ? 
                                ' '.repeat(Math.floor(indentLevel) * size) : 
                                '\t'.repeat(Math.floor(indentLevel));
                            
                            // Replace the line's indentation
                            const newLine = newIndent + line.trimLeft();
                            session.doc.removeFullLines(index, index);
                            session.doc.insertFullLines(index, [newLine]);
                        }
                    });
                    
                    // Restore cursor position
                    editor.moveCursorToPosition(cursorPosition);
                }

                function updateEditorTheme(editor, newTheme) {
                    editor.setTheme(`ace/theme/${newTheme}`);
                    editor.renderer.updateFull(true); // Force full refresh
                }

                onMounted(async () => {
                    editor.value = ace.edit("editor");
                    editor.value.setTheme("ace/theme/monokai");
                    editor.value.session.setMode("ace/mode/javascript");
                    editor.value.setFontSize(14);

                    editor.value.selection.on('changeCursor', () => {
                        const pos = editor.value.getCursorPosition();
                        cursor.value = {
                            row: pos.row + 1,
                            column: pos.column + 1
                        };
                    });

                    lucide.createIcons();

                    setTimeout(updateSettingsButtonWidth, 100);
                    editor.value.session.on('change', () => setTimeout(updateSettingsButtonWidth, 0));
                    editor.value.session.on('changeScrollLeft', updateSettingsButtonWidth);
                    editor.value.renderer.on('resize', updateSettingsButtonWidth);
                    editor.value.session.on('changeScrollTop', updateSettingsButtonWidth);

                    try {
                        availableFonts.value = await detectMonospaceFonts();
                        if (availableFonts.value.length === 0) {
                            availableFonts.value = ['monospace'];
                        }
                    } catch (e) {
                        console.error('Error detecting fonts:', e);
                        availableFonts.value = ['monospace'];
                    }

                    setTimeout(() => {
                        hideLoadingScreen();
                    }, 100);
                });

                watch([syntax, theme, indentSize, indentType, fontSize, selectedFont, wordWrap], 
                    ([newSyntax, newTheme, newIndentSize, newIndentType, newFontSize, newFont, newWordWrap], oldValues) => {
                        if (editor.value) {
                            const prevIndentSize = oldValues?.[2];
                            const prevIndentType = oldValues?.[3];
                            
                            // Handle theme change
                            if (oldValues?.[1] !== newTheme) {
                                editor.value.setTheme(`ace/theme/${newTheme}`);
                                
                                // Force theme update by directly manipulating classes
                                const editorElement = editor.value.container;
                                const oldThemeClass = Array.from(editorElement.classList)
                                    .find(className => className.startsWith('ace-'));
                                if (oldThemeClass) {
                                    editorElement.classList.remove(oldThemeClass);
                                }
                                editorElement.classList.add(`ace-${newTheme}`);
                                
                                // Force a redraw
                                editor.value.renderer.updateFull(true);
                                requestAnimationFrame(() => {
                                    editor.value.renderer.updateFull(true);
                                });
                            }
                            
                            editor.value.session.setMode(`ace/mode/${newSyntax}`);
                            
                            // Handle indentation change
                            if (prevIndentSize !== newIndentSize || prevIndentType !== newIndentType) {
                                const session = editor.value.session;
                                
                                // First, set the new tab size
                                session.setTabSize(newIndentSize);
                                session.setUseSoftTabs(newIndentType === 'spaces');
                                
                                // Then, reindent the entire document
                                const lines = session.doc.getAllLines();
                                let cursorPos = editor.value.getCursorPosition();
                                
                                lines.forEach((line, index) => {
                                    if (line.trim().length > 0) { // Only process non-empty lines
                                        // First convert all indentation to spaces
                                        let spaceLine = session.doc.$lines[index];
                                        // Calculate the actual indentation level (how many levels deep)
                                        let indentLevel = 0;
                                        for (let i = 0; i < spaceLine.length; i++) {
                                            if (spaceLine[i] === ' ') indentLevel++;
                                            else if (spaceLine[i] === '\t') indentLevel += prevIndentSize || 4;
                                            else break;
                                        }
                                        indentLevel = Math.floor(indentLevel / (prevIndentSize || 4));
                                        
                                        // Create new indentation
                                        let newIndent;
                                        if (newIndentType === 'spaces') {
                                            newIndent = ' '.repeat(indentLevel * newIndentSize);
                                        } else {
                                            newIndent = '\t'.repeat(indentLevel);
                                        }
                                        
                                        // Replace the line
                                        let newLine = newIndent + line.trimLeft();
                                        session.doc.removeFullLines(index, index);
                                        session.doc.insertFullLines(index, [newLine]);
                                    }
                                });
                                
                                // Restore cursor position
                                editor.value.moveCursorToPosition(cursorPos);
                            }
                            
                            editor.value.setFontSize(parseInt(newFontSize));
                            editor.value.container.style.fontFamily = newFont;
                            editor.value.session.setUseWrapMode(newWordWrap);
                        }
                    }, { deep: true }
                );

                return {
                    cursor,
                    isSettingsModalOpen,
                    syntax,
                    theme,
                    indentSize,
                    indentType,
                    fontSize,
                    selectedFont,
                    availableFonts,
                    darkThemes,
                    lightThemes,
                    wordWrap,
                    openSettingsModal,
                    closeSettingsModal,
                    restoreDefaults
                };
            }
        }).mount('#app');
    </script>
</body>
</html>